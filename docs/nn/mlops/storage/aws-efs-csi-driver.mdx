---
id: aws-efs-csi-driver
title: aws-efs-csi-driver
sidebar_label: aws-efs-csi-driver
description: aws-efs-csi-driver
keywords:
  - aws-efs-csi-driver
---

AWS EFS Container Storage Interface Driver

## Prerequisites

```python
# CSI

name = f"{const.CLUSTER_NAME}-efs-csi-driver-policy"
efs_csi_driver_policy = aws.iam.Policy(
    name,
    name=name,
    policy=json.dumps(
        {
            "Statement": [
                {
                    "Action": [
                        "elasticfilesystem:DescribeAccessPoints",
                        "elasticfilesystem:DescribeFileSystems",
                    ],
                    "Effect": "Allow",
                    "Resource": "*",
                },
                {
                    "Action": ["elasticfilesystem:CreateAccessPoint"],
                    "Condition": {
                        "StringLike": {
                            "aws:RequestTag/efs.csi.aws.com/cluster": "true"
                        }
                    },
                    "Effect": "Allow",
                    "Resource": "*",
                },
                {
                    "Action": "elasticfilesystem:DeleteAccessPoint",
                    "Condition": {
                        "StringEquals": {
                            "aws:ResourceTag/efs.csi.aws.com/cluster": "true"
                        }
                    },
                    "Effect": "Allow",
                    "Resource": "*",
                },
            ],
            "Version": "2012-10-17",
        }
    ),
    tags={
        "Name": name,
    },
)

name = f"{const.CLUSTER_NAME}-efs-csi-driver-role"
efs_csi_driver_role = aws.iam.Role(
    name,
    name=name,
    assume_role_policy=pulumi.Output.all(
        account_id=const.AWS_ACCOUNT_ID,
        oidc_url=eks.oidc_provider.url,
    ).apply(
        lambda args: json.dumps(
            {
                "Version": "2012-10-17",
                "Statement": [
                    {
                        "Effect": "Allow",
                        "Principal": {
                            "Federated": f"arn:aws:iam::{args['account_id']}:oidc-provider/{args['oidc_url']}"
                        },
                        "Action": "sts:AssumeRoleWithWebIdentity",
                        "Condition": {
                            "StringEquals": {
                                f"{args['oidc_url']}:sub": "system:serviceaccount:kube-system:efs-csi-controller-sa"
                            }
                        },
                    }
                ],
            }
        )
    ),
    tags={
        "Name": name,
    },
)

efs_csi_driver_rpa = aws.iam.RolePolicyAttachment(
    f"{const.CLUSTER_NAME}-efs-csi-driver-rpa-0",
    role=efs_csi_driver_role.name,
    policy_arn=efs_csi_driver_policy.arn,
)

# Export

pulumi.export("efs_csi_driver_role_arn", efs_csi_driver_role.arn)
```

## Installation

```shell
helm repo add aws-efs-csi-driver https://kubernetes-sigs.github.io/aws-efs-csi-driver \
&& helm repo update
```

```shell
mkdir -p storage/aws-efs-csi-driver/{dynamic,helm,static}
```

```shell
helm search repo aws-efs-csi-driver/aws-efs-csi-driver -l | head -n 10
```

```shell
helm show values aws-efs-csi-driver/aws-efs-csi-driver \
    --version 2.2.4 \
    > storage/aws-efs-csi-driver/helm/values.yaml
```

[이미지 주소](https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/add-ons-images.html)를 참고하여 아래 옵션을 수정합니다.

```shell
pulumi stack output efs_csi_driver_role_arn
```

```yaml title="storage/aws-efs-csi-driver/helm/values.yaml"
image:
  repository: 602401143452.dkr.ecr.us-west-2.amazonaws.com/eks/aws-efs-csi-driver

controller:
  serviceAccount:
    create: false
    name: efs-csi-controller-sa
    annotations:
      eks.amazonaws.com/role-arn: arn:aws:iam::<account-id>:role/<role-name>
```

```shell
helm upgrade aws-efs-csi-driver aws-efs-csi-driver/aws-efs-csi-driver \
    --install \
    --version 2.2.4 \
    -n kube-system \
    --create-namespace \
    -f storage/aws-efs-csi-driver/helm/values.yaml
```

## StorageClass

:::warning
EFS에 접근 가능한 SecurityGroup을 NodeGroup에 추가해줘야 합니다.
:::

:::info
Provisioning 시에 선언되는 storage 크기는 더미 값입니다. 실제 사용 시에는 제한이 없습니다.
:::

### Static Provisioning

```yaml title="storage/aws-efs-csi-driver/static/efs-sp-sc.yaml"
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: efs-sp-sc
provisioner: efs.csi.aws.com
```

```shell
pulumi stack output efs_id
```

```yaml title="storage/aws-efs-csi-driver/static/efs-sp-pvc.yaml" {15}
apiVersion: v1
kind: PersistentVolume
metadata:
  name: efs-sp-pv
spec:
  capacity:
    storage: 5Gi
  volumeMode: Filesystem
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  storageClassName: efs-sp-sc
  csi:
    driver: efs.csi.aws.com
    volumeHandle: <FileSystemId>[:<SubPath>][:<AccessPointId>]

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: efs-sp-pvc
spec:
  accessModes:
    - ReadWriteMany
  storageClassName: efs-sp-sc
  resources:
    requests:
      storage: 5Gi
```

:::info
`<FileSystemId>`, `<FileSystemId>:<SubPath>`, `<FileSystemId>::<AccessPointId>`, `<FileSystemId>:<SubPath>:<AccessPointId>`조합이 가능합니다.
:::

### Dynamic Provisioning

```yaml title="storage/aws-efs-csi-driver/dynamic/efs-dp-sc.yaml" {8-10}
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: efs-dp-sc
provisioner: efs.csi.aws.com
parameters:
  provisioningMode: efs-ap # PVC를 선언하면 AccessPoint가 생성됩니다.
  fileSystemId: <FileSystemId>
  directoryPerms: "755"
  basePath: "/k8s" # Default: "/". AccessPoint의 루트 디렉터리들이 생성될 위치 입니다.
```

```yaml title="storage/aws-efs-csi-driver/dynamic/efs-dp-pvc.yaml"
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: efs-dp-pvc
spec:
  accessModes:
    - ReadWriteMany
  storageClassName: efs-dp-sc
  resources:
    requests:
      storage: 5Gi
```

## Reference

- [https://github.com/kubernetes-sigs/aws-efs-csi-driver](https://github.com/kubernetes-sigs/aws-efs-csi-driver)
- [https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/efs-csi.html](https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/efs-csi.html)
