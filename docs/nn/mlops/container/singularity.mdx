---
id: singularity
title: singularity for HPC
sidebar_label: singularity for HPC
description: singularity for HPC
keywords:
  - HPC
  - singularity
---

## Installation

### Prerequisites

```shell
sudo yum update -y \
&& sudo yum groupinstall -y 'Development Tools' \
&& sudo yum install -y \
    openssl-devel \
    libuuid-devel \
    libseccomp-devel \
    wget \
    squashfs-tools \
    cryptsetup
```

or

```shell
sudo apt-get update -y \
&& sudo apt-get install -y \
    build-essential \
    uuid-dev \
    libgpgme-dev \
    squashfs-tools \
    libseccomp-dev \
    wget \
    pkg-config \
    git \
    cryptsetup-bin
```

### Go

```shell
wget https://go.dev/dl/go1.17.3.linux-amd64.tar.gz
```

```shell
sudo mkdir -p /opt/go/1.17.3
```

```shell
pv -ptrb go1.17.3.linux-amd64.tar.gz | sudo tar -xzp -C /opt/go/1.17.3
```

```shell
export PATH=/opt/go/1.17.3/go/bin:$PATH
```

### Singularity

```shell
sudo mkdir -p /opt/singularity/3.8.4
```

```shell
git clone https://github.com/hpcng/singularity.git -b v3.8.4 --depth 1 \
&& cd singularity
```

```shell
./mconfig --prefix=/opt/singularity/3.8.4 \
&& make -C builddir \
&& sudo make -C builddir install
```

`./mconfig --help`

```shell
export PATH=/opt/singularity/3.8.4/bin:$PATH
```

:::info
`/opt/singularity/3.8.4/etc/singularity/singularity.conf`을 통해 singularity의 기본 설정을 변경할 수 있습니다.
:::

## Uninstall

```shell
sudo rm -r /opt/singularity/3.8.4
```

## Bind Paths and Mounts

Singularity의 특징 중 하나는 `singularity run`, `singularity exec`, `singularity shell` `singularity instance start` 명령어를 사용할 때, Host와 Container가 기본적으로 공유하는 경로가 존재한다는 것입니다.

옵션 또는 환경변수를 통해 바인딩 할 수 있습니다.

- `--bind Host[:Container[:Option]]`
- `SINGULARITY_BIND=Host[:Container[:Option]]`
- 옵션을 여러 번 쓰거나, `,`를 사용하여 여러 개의 규칙을 지정할 수 있습니다.
- Container가 정해져 있지 않은 경우 Host와 같은 경로를 사용한다고 가정합니다.
- `Option`으로는 `ro`(read only)와 `rw`(read write, default)를 지정할 수 있습니다.

기본 설정에서 바인딩 되는 위치는 아래와 같습니다.

- `$HOME`
- `/sys:/sys`
- `/proc:/proc`
- `/tmp:/tmp`
- `/var/tmp:/var/tmp`
- `/etc/resolv.conf:/etc/resolv.conf`
- `/etc/passwd:/etc/passwd`
- `$PWD`

## Build Test

```shell
singularity pull docker://ubuntu:20.04
```

```shell
singularity build --sandbox ubuntu ubuntu_20.04.sif
```

```shell
sudo `which singularity` shell --writable ubuntu
```

:::warning
`singularity shell` 명령으로 컨테이너에 접속해서 작업을 할 때, Host와 Container간 공유되는 경로에 주의해야합니다.
:::

## Definition file

```shell
Bootstrap: localimage
From: ubuntu_20.04.sif
Stage: build

%setup
    touch /file1
    touch ${SINGULARITY_ROOTFS}/file2

%files
    /file1
    /file1 /opt

%environment
    export LISTEN_PORT=12345
    export LC_ALL=C

%post
    apt-get update && apt-get install -y netcat
    NOW=`date`
    echo "export NOW=\"${NOW}\"" >> $SINGULARITY_ENVIRONMENT

%runscript
    echo "Container was created $NOW"
    echo "Arguments received: $*"
    exec echo "$@"

%startscript
    nc -lp $LISTEN_PORT

%test
    grep -q NAME=\"Ubuntu\" /etc/os-release
    if [ $? -eq 0 ]; then
        echo "Container base is Ubuntu as expected."
    else
        echo "Container base is not Ubuntu."
        exit 1
    fi

%labels
    Author d@sylabs.io
    Version v0.0.1

%help
    This is a demo container used to illustrate a def file that uses all
    supported sections.
```

## Reference

- [https://github.com/hpcng/singularity](https://github.com/hpcng/singularity)
- [https://singularity.hpcng.org/user-docs/3.8/bind_paths_and_mounts.html](https://singularity.hpcng.org/user-docs/3.8/bind_paths_and_mounts.html)
- [https://singularity.hpcng.org/user-docs/3.8/definition_files.html](https://singularity.hpcng.org/user-docs/3.8/definition_files.html)
