---
id: karpenter
title: Karpenter
sidebar_label: Karpenter
description: Karpenter
keywords:
  - karpenter
---

## Prerequisites

EKS cluster tag에 `"karpenter.sh/discovery": <cluster_name>`을 추가합니다.

[https://docs.aws.amazon.com/ko_kr/batch/latest/userguide/spot_fleet_IAM_role.html](https://docs.aws.amazon.com/ko_kr/batch/latest/userguide/spot_fleet_IAM_role.html)

```python
_tags = {"Name": f"{common.cluster_name}-karpenter-controller-policy"}
_tags.update(common.tags)
karpenter_controller_policy = aws.iam.Policy(
    _tags["Name"],
    name=_tags["Name"],
    policy=Path("iam/karpenter-controller-policy.json").read_text(),
    tags=_tags,
)

_assume_role_policy = pulumi.Output.all(
    account_id=common.account_id,
    oidc_url=cluster_oidc.url,
).apply(
    lambda args: json.dumps(
        {
            "Version": "2012-10-17",
            "Statement": [
                {
                    "Effect": "Allow",
                    "Principal": {
                        "Federated": f"arn:aws:iam::{args['account_id']}:oidc-provider/{args['oidc_url']}"
                    },
                    "Action": "sts:AssumeRoleWithWebIdentity",
                    "Condition": {
                        "StringEquals": {
                            f"{args['oidc_url']}:sub": "system:serviceaccount:karpenter:karpenter"
                        }
                    },
                }
            ],
        }
    )
)
_tags = {"Name": f"{common.cluster_name}-karpenter-controller-role"}
_tags.update(common.tags)
karpenter_controller_role = aws.iam.Role(
    _tags["Name"],
    name=_tags["Name"],
    assume_role_policy=_assume_role_policy,
    tags=_tags,
)

_tags = {"Name": f"{common.cluster_name}-karpenter-controller-rpa"}
karpenter_controller_rpa = aws.iam.RolePolicyAttachment(
    _tags["Name"],
    policy_arn=karpenter_controller_policy.arn,
    role=karpenter_controller_role.name,
)

pulumi.export("karpenter_controller_role_arn", karpenter_controller_role.arn)
```

```python
_tags = {"Name": f"{common.cluster_name}-default-ng-role"}
_tags.update(common.tags)
default_ng_role = aws.iam.Role(
    _tags["Name"],
    assume_role_policy=Path("iam/ec2_assume_role_policy.json").read_text(
        encoding="utf-8"
    ),
    tags=_tags,
    opts=pulumi.ResourceOptions(parent=cluster),
)

node_policy_arns = [
    "arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy",
    "arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly",
    "arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy",
    "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore",  # Karpenter
]

default_ng_rpas = []
for i, arn in enumerate(node_policy_arns):
    _tags = {"Name": f"{common.cluster_name}-default-ng-rpa-{i}"}
    default_ng_rpas.append(
        aws.iam.RolePolicyAttachment(
            _tags["Name"],
            policy_arn=arn,
            role=default_ng_role.name,
            opts=pulumi.ResourceOptions(parent=default_ng_role),
        )
    )

_tags = {"Name": f"{common.cluster_name}-default-ng-profile"}
_tags.update(common.tags)
default_ng_profile = aws.iam.InstanceProfile(
    _tags["Name"],
    name=_tags["Name"],
    role=default_ng_role.name,
    tags=_tags,
    opts=pulumi.ResourceOptions(parent=default_ng_role),
)
```

## Installation

```shell
helm repo add karpenter https://charts.karpenter.sh \
&& helm repo update
```

```shell
mkdir -p karpenter/helm
```

```shell
helm search repo karpenter/karpenter -l | head -n 10
```

```shell
helm show values karpenter/karpenter \
    --version 0.6.0 \
    > karpenter/helm/values.yaml
```

```yaml tilte="karpenter/helm/values.yaml"
serviceAccount:
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::<account-id>:role/<role-name>

controller:
  clusterName: <cluster-name>
  clusterEndpoint: <cluster-endpoint>

aws:
  defaultInstanceProfile: <instance-profile>
```

```shell
helm upgrade karpenter karpenter/karpenter \
    --install \
    --version 0.6.0 \
    -n karpenter \
    --create-namespace \
    -f karpenter/helm/values.yaml
```

## Provisioner

## Reference

- [https://github.com/aws/karpenter](https://github.com/aws/karpenter)
- [https://karpenter.sh/v0.6.0/getting-started-with-terraform/](https://karpenter.sh/v0.6.0/getting-started-with-terraform/)
- [https://docs.aws.amazon.com/ko_kr/batch/latest/userguide/spot_fleet_IAM_role.html](https://docs.aws.amazon.com/ko_kr/batch/latest/userguide/spot_fleet_IAM_role.html)
