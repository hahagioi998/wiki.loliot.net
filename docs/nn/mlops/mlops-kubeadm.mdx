---
id: mlops-kubeadm
title: Kubeadm
sidebar_label: Kubeadm
description: Kubeadm
keywords:
  - Kubeadm
---

## Installation

- 최소 필요 조건
  - 2 CPU
  - 2 GB memory

```yaml title="kubeadm-installation.yaml" {5}
---
- hosts: all
  become: yes
  vars:
    version: 1.19.15-00
  tasks:
    - name: install required
      apt:
        name: '{{ item }}'
        state: latest
        update_cache: yes
      loop: ['apt-transport-https', 'ca-certificates', 'curl']

    - name: add kubernetes GPG apt key
      apt_key:
        url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
        keyring: /usr/share/keyrings/kubernetes-archive-keyring.gpg

    - name: add kubernetes repository
      apt_repository:
        repo: deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg]
          https://apt.kubernetes.io/ kubernetes-xenial main
        filename: kubernetes

    - name: install kubeadm kubectl version={{ version }}
      apt:
        name: '{{ item }}={{ version }}'
        update_cache: yes
        force: yes
      loop: ['kubelet', 'kubeadm', 'kubectl']

    - name: disable swap
      shell: swapoff -a
      when: ansible_swaptotal_mb > 0

    - name: remove swapfile from /etc/fstab
      replace:
        path: /etc/fstab
        regexp: '^([^#].*?\sswap\s+sw\s+.*)$'
        replace: '# \1'

    - name: add br_netfilter to modules-load.d
      lineinfile:
        path: /etc/modules-load.d/k8s.conf
        line: br_netfilter
        create: yes

    - name: modprobe br_netfilter
      shell: modprobe br_netfilter

    - name: add netbridge config ip6
      lineinfile:
        path: /etc/sysctl.d/k8s.conf
        line: 'net.bridge.bridge-nf-call-ip6tables = 1'
        create: yes

    - name: add netbridge config ip4
      lineinfile:
        path: /etc/sysctl.d/k8s.conf
        line: 'net.bridge.bridge-nf-call-iptables = 1'
        create: yes

    - name: update sysctl
      shell: sysctl --system
```

### Complition

```shell title=".bashrc"
source <(kubectl completion bash)

alias k=kubectl
complete -F __start_kubectl k
```

```shell title=".zshrc"
source <(kubectl completion zsh)

alias k=kubectl
complete -F __start_kubectl k
```

## Control plane node

| 프로토콜 | 방향     | 포트 범위 | 목적                     | 사용자               |
| -------- | -------- | --------- | ------------------------ | -------------------- |
| TCP      | 인바운드 | 6443\*    | 쿠버네티스 API 서버      | 모두                 |
| TCP      | 인바운드 | 2379-2380 | etcd 서버 클라이언트 API | kube-apiserver, etcd |
| TCP      | 인바운드 | 10250     | kubelet API              | 자체, 컨트롤 플레인  |
| TCP      | 인바운드 | 10251     | kube-scheduler           | 자체                 |
| TCP      | 인바운드 | 10252     | kube-controller-manager  | 자체                 |

```shell
sudo kubeadm init \
    --pod-network-cidr 192.168.0.0/16
```

- `--pod-network-cidr`: pod network로 사용되는 IP 주소 범위 ex) `192.168.0.0/16`
- `--apiserver-advertise-address`:
  - Default: 해당 노드 IP
  - 다른 노드가 API Sever에 접속하기 위한 IP 주소
- `--apiserver-cert-extra-sans`:
- `--service-cidr`:
  - Default: `10.96.0.0/12` (10.96.0.0 ~ 10.111.255.255)
- `--control-plane-endpoint`:

```shell
mkdir -p $HOME/.kube \
&& sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config \
&& sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

```shell
kubectl get pods -n kube-system
```

`coredns` 체크

### calico

[Go to calico installation](nn/mlops/mlops-cni-calico.mdx)

### token

```shell
sudo kubeadm token list
```

### hash

```shell
openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt \
| openssl rsa -pubin -outform der 2>/dev/null \
| openssl dgst -sha256 -hex | sed 's/^.* //'
```

## Worker node

| 프로토콜 | 방향     | 포트 범위   | 목적        | 사용자              |
| -------- | -------- | ----------- | ----------- | ------------------- |
| TCP      | 인바운드 | 10250       | kubelet API | 자체, 컨트롤 플레인 |
| TCP      | 인바운드 | 30000-32767 | NodePort    | 서비스† 모두        |

```shell
sudo kubeadm join <control plane ip>:6443 \
    --token <token> \
    --discovery-token-ca-cert-hash sha256:<hash>
```

## reset

```shell
sudo kubeadm reset -f
```

```shell
sudo rm -r /etc/kubernetes/manifests $HOME/.kube/config
```

## Reference

- [https://kubernetes.io/ko/docs/setup/production-environment/tools/kubeadm/install-kubeadm/](https://kubernetes.io/ko/docs/setup/production-environment/tools/kubeadm/install-kubeadm/)
- [https://kubernetes.io/docs/reference/setup-tools/kubeadm/](https://kubernetes.io/docs/reference/setup-tools/kubeadm/)
