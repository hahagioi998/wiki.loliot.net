---
id: kubeadm
title: Kubeadm
sidebar_label: Kubeadm
description: Kubeadm
keywords:
  - Kubeadm
---

## Installation

- 최소 필요 조건
  - 2 CPU
  - 2 GB memory

```yaml title="kubeadm-installation.yaml" {5}
---
- hosts: all
  become: yes
  vars:
    version: 1.19.15-00
  tasks:
    - name: Install requirements
      apt:
        name: '{{ item }}'
        state: latest
        update_cache: yes
      loop: ['apt-transport-https', 'ca-certificates', 'curl']

    - name: Add kubernetes GPG apt key
      apt_key:
        url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
        keyring: /usr/share/keyrings/kubernetes-archive-keyring.gpg

    - name: Add kubernetes repository
      apt_repository:
        repo: deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg]
          https://apt.kubernetes.io/ kubernetes-xenial main
        filename: kubernetes

    - name: Install kubeadm kubectl kubelet version={{ version }}
      apt:
        name: '{{ item }}={{ version }}'
        update_cache: yes
        force: yes
      loop: ['kubelet', 'kubeadm', 'kubectl']

    - name: Disable swap
      command: swapoff -a
      when: ansible_swaptotal_mb > 0

    - name: Remove swapfile from /etc/fstab
      replace:
        path: /etc/fstab
        regexp: '^([^#].*?\sswap\s+sw\s+.*)$'
        replace: '# \1'

    - name: Add br_netfilter to modules-load.d
      lineinfile:
        path: /etc/modules-load.d/k8s.conf
        line: br_netfilter
        mode: 0644
        create: yes

    - name: modprobe br_netfilter
      modprobe:
        name: br_netfilter

    - name: Add netbridge config ip6
      lineinfile:
        path: /etc/sysctl.d/k8s.conf
        line: 'net.bridge.bridge-nf-call-ip6tables = 1'
        mode: 0644
        create: yes

    - name: Add netbridge config ip4
      lineinfile:
        path: /etc/sysctl.d/k8s.conf
        line: 'net.bridge.bridge-nf-call-iptables = 1'
        mode: 0644
        create: yes

    - name: Update sysctl
      shell: sysctl --system

    - name: Add kubectl completion to /home/{{ ansible_user }}/.bashrc
      lineinfile:
        path: /home/{{ ansible_user }}/.bashrc
        line: |
          source <(kubectl completion bash)

          alias k=kubectl
          complete -F __start_kubectl k
        mode: 0644

    # AWS
    - name: Set hostname to aws private dns name
      shell: hostnamectl set-hostname $(curl http://169.254.169.254/latest/meta-data/local-hostname)
```

### Complition

```shell title=".bashrc"
source <(kubectl completion bash)

alias k=kubectl
complete -F __start_kubectl k
```

```shell title=".zshrc"
source <(kubectl completion zsh)

alias k=kubectl
complete -F __start_kubectl k
```

## Control plane node

| 프로토콜 | 방향     | 포트 범위 | 목적                     | 사용자               |
| -------- | -------- | --------- | ------------------------ | -------------------- |
| TCP      | 인바운드 | 6443\*    | 쿠버네티스 API 서버      | 모두                 |
| TCP      | 인바운드 | 2379-2380 | etcd 서버 클라이언트 API | kube-apiserver, etcd |
| TCP      | 인바운드 | 10250     | kubelet API              | 자체, 컨트롤 플레인  |
| TCP      | 인바운드 | 10251     | kube-scheduler           | 자체                 |
| TCP      | 인바운드 | 10252     | kube-controller-manager  | 자체                 |

```yaml title="kubeadm-master.yaml" {3,4,7,22}
apiVersion: kubeadm.k8s.io/v1beta2
kind: ClusterConfiguration
clusterName: hhk-cluster
kubernetesVersion: v1.19.15
networking:
  dnsDomain: cluster.local
  podSubnet: 192.168.0.0/16 # pod network에 할당되는 IP 주소 범위
  serviceSubnet: 10.96.0.0/12 # 10.96.0.0 ~ 10.111.255.255
# AWS
apiServer:
  extraArgs:
    cloud-provider: external
controllerManager:
  extraArgs:
    cloud-provider: external
---
# AWS
apiVersion: kubeadm.k8s.io/v1beta3
kind: InitConfiguration
nodeRegistration:
  kubeletExtraArgs:
    cloud-provider: external
---
kind: KubeletConfiguration
apiVersion: kubelet.config.k8s.io/v1beta1
cgroupDriver: systemd
```

```shell
sudo kubeadm init --config kubeadm-master.yaml
```

```shell
mkdir -p $HOME/.kube \
&& sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config \
&& sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

### aws-cloud-controller-manager

```shell
sudo snap install helm --classic
```

```shell
helm repo add aws-cloud-controller-manager https://kubernetes.github.io/cloud-provider-aws
helm repo update
```

```shell
helm upgrade --install aws-cloud-controller-manager aws-cloud-controller-manager/aws-cloud-controller-manager \
    --set "args={--v=2,--cloud-provider=aws,--configure-cloud-routes=false}"
```

### calico

```shell
kubectl get pods -n kube-system
```

`coredns`가 `Pending` 상태인 것을 확인할 수 있습니다.

[Calico](nn/mlops/cni-calico.mdx) 글을 읽어보시기 바랍니다.

### token

```shell
sudo kubeadm token list
```

### hash

```shell
openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt \
| openssl rsa -pubin -outform der 2>/dev/null \
| openssl dgst -sha256 -hex | sed 's/^.* //'
```

## Worker node

| 프로토콜 | 방향     | 포트 범위   | 목적        | 사용자              |
| -------- | -------- | ----------- | ----------- | ------------------- |
| TCP      | 인바운드 | 10250       | kubelet API | 자체, 컨트롤 플레인 |
| TCP      | 인바운드 | 30000-32767 | NodePort    | 서비스† 모두        |

```yaml title="kubeadm-worker.yaml" {6,7,9}
---
apiVersion: kubeadm.k8s.io/v1beta2
kind: JoinConfiguration
discovery:
  bootstrapToken:
    apiServerEndpoint: <master endpoint>:6443
    token: <token>
    caCertHashes:
      - <hash>
nodeRegistration:
  kubeletExtraArgs:
    cloud-provider: external
```

```shell
sudo kubeadm join --config kubeadm-worker.yaml
```

## reset

```shell
sudo kubeadm reset -f
```

```shell
sudo rm -r /etc/kubernetes/manifests $HOME/.kube/config
```

## Reference

- [https://kubernetes.io/ko/docs/setup/production-environment/tools/kubeadm/install-kubeadm/](https://kubernetes.io/ko/docs/setup/production-environment/tools/kubeadm/install-kubeadm/)
- [https://kubernetes.io/docs/reference/setup-tools/kubeadm/](https://kubernetes.io/docs/reference/setup-tools/kubeadm/)
- [https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/configure-cgroup-driver/](https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/configure-cgroup-driver/)
- [https://tanzu.vmware.com/content/blog/bootstrapping-an-aws-integrated-kubernetes-1-15-cluster-with-kubeadm](https://tanzu.vmware.com/content/blog/bootstrapping-an-aws-integrated-kubernetes-1-15-cluster-with-kubeadm)
- [https://kubernetes.io/docs/reference/config-api/kubeadm-config.v1beta3/](https://kubernetes.io/docs/reference/config-api/kubeadm-config.v1beta3/)
- [https://cloud-provider-aws.sigs.k8s.io/prerequisites/](https://cloud-provider-aws.sigs.k8s.io/prerequisites/)
- [https://blog.scottlowe.org/2021/10/12/using-the-external-aws-cloud-provider-for-kubernetes/](https://blog.scottlowe.org/2021/10/12/using-the-external-aws-cloud-provider-for-kubernetes/)
