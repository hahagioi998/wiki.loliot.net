---
id: argo-workflows
title: Argo Workflows
sidebar_label: Argo Workflows
description: Argo Workflows
keywords:
  - argo
  - workflows
---

## Installation

```shell
wget https://github.com/argoproj/argo-workflows/releases/latest/download/argo-linux-amd64.gz \
&& gzip -d argo-linux-amd64.gz \
&& sudo mv argo-linux-amd64 /usr/local/bin/argo \
&& sudo chmod +x /usr/local/bin/argo
```

```shell
helm repo add argo https://argoproj.github.io/argo-helm \
&& helm repo update
```

```shell
mkdir -p cicd/argo/workflows
```

```shell
helm search repo argo/argo-workflows -l
```

```shell
helm show values argo/argo-workflows \
    --version 0.9.2 \
    > cicd/argo/workflows/values.yaml
```

```shell
helm upgrade argo-workflows argo/argo-workflows \
    --install \
    --version 0.9.2 \
    -n cicd \
    --values cicd/argo/workflows/values.yaml
```

## User

### SSO-Dex with Argo CD

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: argo-workflows-sso
  namespace: cicd
data:
  # `printf argo-workflows-sso | base64`
  client-id: YXJnby13b3JrZmxvd3Mtc3Nv
  # `printf MY-SECRET-STRING-CAN-BE-UUID | base64`
  client-secret: TVktU0VDUkVULVNUUklORy1DQU4tQkUtVVVJRA==
```

```yaml title="cicd/argo/cd/values.yaml"
dex:
  env:
    - name: ARGO_WORKFLOWS_SSO_CLIENT_SECRET
      valueFrom:
        secretKeyRef:
          name: argo-workflows-sso
          key: client-secret

server:
  config:
    dex.config: |
      staticClients:
        - id: argo-workflows-sso
          name: Argo Workflow
          redirectURIs:
            - <workflow-server-url>/oauth2/callback
          secretEnv: ARGO_WORKFLOWS_SSO_CLIENT_SECRET
```

:::info
Dex는 클라이언트(`aud(audience)`)대신 다른 클라이언트(`azp(authorized party)`)에게 ID 토큰 발행을 맞길 수 있는 기능이 있습니다. `staticClients.trustedPeers: []`에 azp가 될 클라이언트의 id를 추가하면 됩니다.
:::

```yaml title="cicd/argo/workflows/values.yaml"
server:
  # ConfigMap.data.sso |, name: workflow-controller-configmap
  sso:
    issuer: <argo-cd-server-url>/api/dex
    sessionExpiry: 120h
    clientId:
      name: argo-workflows-sso
      key: client-id
    clientSecret:
      name: argo-workflows-sso
      key: client-secret
    redirectUrl: <workflow-server-url>/oauth2/callback
```

### RBAC

```yaml title="cicd/argo/workflows/values.yaml"
server:
  # ConfigMap.data.config: |, name: workflow-controller-configmap
  sso:
    scopes:
      - groups
    rbac:
      enabled: true
```

```yaml title="cicd/argo/workflows/rbac/guest-sa.yaml"
apiVersion: v1
kind: ServiceAccount
metadata:
  name: guest-sa
  namespace: cicd
  annotations:
    workflows.argoproj.io/rbac-rule: "true"
    # 이 설정이 guest 설정이 될 수 있도록 다른 ServiceAccount는 precedence를 1
    # 이상으로 설정해주세요
    workflows.argoproj.io/rbac-rule-precedence: "0"
```

```yaml title="cicd/argo/workflows/rbac/admin-sa.yaml"
apiVersion: v1
kind: ServiceAccount
metadata:
  name: admin-sa
  namespace: cicd
  annotations:
    workflows.argoproj.io/rbac-rule: "'<group>' in groups"
    workflows.argoproj.io/rbac-rule-precedence: "1"

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: argo-workflows-admin-binding
subjects:
  - kind: ServiceAccount
    name: admin-sa
    namespace: cicd
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: argo-workflows-admin
```

## Reference

- [https://argoproj.github.io/argo-workflows](https://argoproj.github.io/argo-workflows)
- [https://dexidp.io/docs/custom-scopes-claims-clients/](https://dexidp.io/docs/custom-scopes-claims-clients/)
